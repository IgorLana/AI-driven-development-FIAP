generator client {
  provider = "prisma-client-js"
}

// Seção 5 (Fase 3) — Temporariamente usando SQLite para desenvolvimento
// Para dev local simples sem Docker
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Company {
  id         String      @id @default(uuid())
  name       String
  domain     String      @unique
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")
  
  users      User[]
  challenges Challenge[]
  
  @@map("companies")
}

model User {
  id                String    @id @default(uuid())
  companyId         String    @map("company_id")
  name              String
  email             String
  passwordHash      String?   @map("password_hash")
  role              String    @default("EMPLOYEE")
  xp                Int       @default(0)
  level             Int       @default(1)
  /// Hash bcrypt do refresh token ativo. NULL = token revogado/logout.
  refreshTokenHash  String?   @map("refresh_token_hash")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  company         Company          @relation(fields: [companyId], references: [id])
  moodLogs        MoodLog[]
  userChallenges  UserChallenge[]
  badges          Badge[]
  
  @@unique([email, companyId])
  @@index([companyId])
  @@map("users")
}

model MoodLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  mood      Int
  tags      String   @default("")
  note      String?
  loggedAt  DateTime @default(now()) @map("logged_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  user User @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([loggedAt])
  @@map("mood_logs")
}

model Challenge {
  id          String    @id @default(uuid())
  companyId   String?   @map("company_id")
  title       String
  description String
  category    String
  xpReward    Int       @map("xp_reward")
  isGlobal    Boolean   @default(false) @map("is_global")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  company         Company?         @relation(fields: [companyId], references: [id])
  userChallenges  UserChallenge[]
  
  @@index([companyId])
  @@index([isGlobal])
  @@map("challenges")
}

model UserChallenge {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  challengeId String    @map("challenge_id")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  
  user      User      @relation(fields: [userId], references: [id])
  challenge Challenge @relation(fields: [challengeId], references: [id])
  
  @@index([userId])
  @@index([challengeId])
  @@index([completedAt])
  @@map("user_challenges")
}

model Badge {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  description String
  iconUrl     String?  @map("icon_url")
  earnedAt    DateTime @default(now()) @map("earned_at")
  
  user User @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@map("badges")
}
